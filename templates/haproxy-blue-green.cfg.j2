global
    daemon
    user haproxy
    group haproxy
    log stdout local0
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    maxconn 4096
    
    # SSL/TLS configuration
{% if ssl_config.enabled %}
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
{% endif %}

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option log-health-checks
    option forwardfor
    option http-server-close
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# Stats frontend
frontend stats
    bind *:{{ haproxy.stats_port }}
    stats enable
    stats uri /stats
    stats refresh 30s
{% if haproxy.stats_user is defined and haproxy.stats_password is defined %}
    stats auth {{ haproxy.stats_user }}:{{ haproxy.stats_password }}
{% endif %}

# HTTP frontend
frontend http_frontend
    bind *:{{ haproxy.http_port }}
    
{% if ssl_config.redirect_http_to_https %}
    # Redirect HTTP to HTTPS
    redirect scheme https code 301
{% else %}
    # Blue-Green routing logic for HTTP
    acl is_{{ blue_green_routing.cluster_subdomain_mapping.source_subdomain }}_domain hdr(host) -i {{ blue_green_routing.cluster_subdomain_mapping.source_subdomain }}
    # Rewrite Host header to point to active environment
    http-request set-header Host {{ blue_green_routing.base_subdomain_prefix }}.{{ blue_green_routing.default_environment }}.{{ blue_green_routing.base_subdomain_suffix }} if is_{{ blue_green_routing.cluster_subdomain_mapping.source_subdomain }}_domain

    # Add custom headers for debugging and routing info
    http-request add-header X-Blue-Green-Cluster {{ blue_green_routing.default_environment }} if is_{{ blue_green_routing.cluster_subdomain_mapping.source_subdomain }}_domain
    http-request add-header X-Blue-Green-Active {{ blue_green_routing.default_environment }} if is_{{ blue_green_routing.cluster_subdomain_mapping.source_subdomain }}_domain
    http-request add-header X-Blue-Green-Original-Host {{ blue_green_routing.cluster_subdomain_mapping.source_subdomain }} if is_{{ blue_green_routing.cluster_subdomain_mapping.source_subdomain }}_domain

    use_backend %[req.hdr(host),{{ blue_green_routing.default_environment }}.{{ blue_green_routing.base_subdomain_suffix }},{{ blue_green_routing.default_environment }})]
{% endif %}

{% if ssl_config.enabled %}
# HTTPS frontend
frontend https_frontend
    bind *:{{ haproxy.https_port }} ssl crt {{ haproxy.cert_dir }}/{{ haproxy.cert_path }}
    
    # Add security headers
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"
    http-response set-header X-Frame-Options "SAMEORIGIN"
    http-response set-header X-Content-Type-Options "nosniff"
    
    # Blue-Green routing logic for HTTPS
    acl is_{{ blue_green_routing.cluster_subdomain_mapping.source_subdomain }}_domain hdr(host) -i {{ blue_green_routing.cluster_subdomain_mapping.source_subdomain }}
    use_backend %[req.hdr(host),{{ blue_green_routing.default_environment }}.{{ blue_green_routing.base_subdomain_suffix }},https-{{ blue_green_routing.default_environment }})]
{% endif %}

{% set blue_backend = blue_green_routing.cluster_subdomain_mapping.blue_subdomain %}
{% set green_backend = blue_green_routing.cluster_subdomain_mapping.green_subdomain %}

# Backend for {{ blue_green_routing.default_environment }}
backend {{ blue_green_routing.default_environment }}
    balance roundrobin
    option httpchk GET /health
    http-request set-header Host {{ blue_backend }}.%[req.hdr(host),regsub(^[^.]+\.,)]

{% if blue_green_routing.backends is defined and blue_green_routing.backends.http_servers is defined and blue_green_routing.backends.http_servers | d([], true) | length > 0 %}
{% for server in blue_green_routing.backends.http_servers %}
    server {{ server.name }} {{ server.address }} {{ server.check }}
{% endfor %}
{% endif %}

# Backend for https-{{ blue_green_routing.default_environment }}
backend https-{{ blue_green_routing.default_environment }}
    balance roundrobin
    option httpchk GET /health
    http-request set-header Host {{ blue_backend }}.%[req.hdr(host),regsub(^[^.]+\.,)]

{% if blue_green_routing.backends is defined and blue_green_routing.backends.https_servers is defined and blue_green_routing.backends.https_servers | d([], true) | length > 0 %}
{% for server in blue_green_routing.backends.https_servers %}
    server {{ server.name }} {{ server.address }} {{ server.check }}
{% endfor %}
{% endif %}
